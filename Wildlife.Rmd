---
title: "Wildlife Ilha do Meio and Rata"
author: "Tati Micheletti"
date: "10/19/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Libraries and source functions

The first step is to load the libraries we need and source the functions that will prepare the data 
and run the models for each one of the species analyzed.

```{r libs}
if(!require("Require")){
    install.packages("Require")
}
library("Require")
Require("googledrive")
Require("reproducible")
Require("data.table")
Require("unmarked")
Require("tictoc")
Require("qs")
# If any packages were installed here, restart your session and re-run the code!
# Here we list all functions and then source all of them:
allFls <- list.files(path = "./functions", full.names = TRUE)
for (fl in allFls){
  message(paste0("Sourcing the function ", basename(fl))) 
  source(file = fl) 
}
```

## Species modeling

After loading libraries and sourcing needed functions, we load the data and 
format the information we need for the models. The 
`dataCOUNTS.csv` file contains all data for the endangered species. For all species, 
we used the N-mixture model described by Dail and Madsen (2011), which has been 
incorporated into the R package `unmarked`. This model, ran using the function 
`pcountOpen()`, allows for model formulations to identify population trends, 
with and without immigration, and for covariates on initial population (described 
as lambda in the model), population growth (gamma), observation probabilities 
(p) and immigration (iota), when this is considered. This model was chosen as it
could be used for all species, as it also allows for different distributions 
(i.e., Poisson, Negative Binomial and Zero Inflated). 

```{r loadAndCheckData}
Data <- loadESData(dataLocation = "data/dataCOUNTS.csv")
```

## Mabuia  

We will start our analysis with the Mabuia (Noronha Skink; *Trachylepis atlantica*).   

First we will run the models for the Ilha do Meio. For the mabuia, Negative 
Binomial Models would have been appropriate, as these model counts, especially if there is variability in the underlying rate of events. However, these are better suited for overdispersed data, which ours 
isn't. Mabuia data is, however, Zero inflated. So ZIP models are more appropriate to use (see Kery, 
2018 and Stoklosa et al. 2022). Moreover, the mabuia population is closed to immigration, considering 
the island is not close enough to others to allow for the species to immigrate. As the predation rate 
by rats is high, we consider every sampling occasion as primary (i.e., open population) and add a 
covariate for the time since the start of the eradication.

```{r mabuiaMeio}
mabuiaMeio <- modelTerrestrials(DT = Data, island = "Ilha do Meio", 
                                species = "Trachylepis atlantica")
```

Now we will run the models for Mabuia for Ilha Rata (our control). 

```{r mabuiaRata}
mabuiaRata <- modelTerrestrials(DT = Data, island = "Ilha Rata", 
                                species = "Trachylepis atlantica")
```

It is important to notice that a couple of the alternative models did not converge 
throwing the error `Hessian is singular.`. This can happen for several reasons 
but in the present case is likely due. Most models that failed had to the parameter 
TSE when to gamma as a covariate, while one model failed with Julian Date. 
Nonetheless, our best model did not have TSE as covariate.

## Elenia  

Next, we will continue our analysis with the Cucuruta (Noronha Elaenia; *Elaenia ridleyana*).  
The observation from Elaenias rendered data that did not present zero inflation. Therefore, 
we used Poisson models, since the overdispersion was also not detected. Differently 
from the Mabuia, the Elaenia does present movement (iota) between the islands, which 
was modeled in the analysis. As we believe the effects of rats on the Elaenia is 
likely restricted to small chicks and eggs, we used the robust design, considering 
a closed population within primary sampling occasions (two days in a row), and open between 
primary sampling occasions (several weeks apart). First we ran the models for the Meio 
island:  

```{r elaeniaMeio}
elaeniaMeio <- modelTerrestrials(DT = Data, island = "Ilha do Meio", 
                                 species = "Elaenia ridleyana")
```

And then for the Rata island:  

```{r elaeniaRata}
elaeniaRata <- modelTerrestrials(DT = Data, island = "Ilha Rata", 
                                 species = "Elaenia ridleyana")
```

## Land Crab  

The analysis of land crabs (*Johngarthia lagostoma*) was then performed. This 
species is known to present increase movement during breeding season. Lesser 
wave action associated with neap high tides (in first and last quarters of moon 
cycle) seem to be preferred. In the same way, peak periods of rain (i.e., March 
or April) also seem to be important factors for these movements. Therefore, we 
added the moon phase to this dataset to use it as a covariate in the model. The 
rainy season should be covered by the covariate JulianDate. Crab data is also 
zero inflated, so we tested both ZIP and NB models. Similarly to Mabuia, although 
the NB model presented a smaller AIC, the dispersion parameter was not significant, 
while the zero inflation was in the ZIP model. Therefore, we opted for a ZIP model.

```{r crabMeio}
crabMeio <- modelTerrestrials(DT = Data, island = "Ilha do Meio", 
                              species = "Johngarthia lagostoma")
```

After modelling crabs for the Ilha do Meio, we perform the same analysis for Ilha Rata:

```{r crabRata}
crabRata <- modelTerrestrials(DT = Data, island = "Ilha Rata", 
                              species = "Johngarthia lagostoma")
```

## Masked Booby

To perform the analysis for a seabird species, the Atoba Mascarado (masked booby; 
*Sula dactylatra*), surveys were performed in all breeding sites across the Ilha 
do Meio (n = 7), and on the only breeding site on Ilha Rata. We used adult counts 
as a proxy for breeding site quality.  

```{r crabMeio}
maskedBoobyMeio <- modelTerrestrials(DT = Data, island = "Ilha do Meio", 
                                     species = "Sula dactylatra")
```

After modelling crabs for the Ilha do Meio, we perform the same analysis for Ilha Rata:

```{r crabRata}
maskedBoobyRata <- modelTerrestrials(DT = Data, island = "Ilha Rata", 
                                     species = "Sula dactylatra")
```

Now that the models were constructed, we need to calculate the change in population 
density through time for Ilha do Meio, and compare it to the control area (Ilha 
Rata).

At last, we build a plot to show the difference in density through time in function 
of time since eradication (TSE).

