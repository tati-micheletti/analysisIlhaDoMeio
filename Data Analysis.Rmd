---
title: "Swiftly squeaky clean: real-time adaptive management eradicates rat overpopulation and brings immediate benefits to tropical island biodiversity -- Data Analysis"
author: "Tati Micheletti"
date: "10/19/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document describes the data analysis done for the paper *Swiftly squeaky clean: real-time adaptive management eradicates rat overpopulation and brings immediate benefits to tropical island biodiversity*.  

## Load Libraries, source functions and set data directory

The first step is to load the libraries we need and source the functions that will prepare the data 
and run the models for each one of the species analyzed.

```{r libs}
if(!require("Require")){
    install.packages("Require")
}
library("Require")
Require("googledrive")
Require("reproducible")
Require("data.table")
Require("terra")
Require("unmarked")
Require("secr")
Require("tictoc")
Require("qs")
# If any packages were installed here, restart your session and re-run the code!
# Here we list all functions and then source all of them:
allFls <- list.files(path = "./functions", full.names = TRUE)
for (fl in allFls){
  message(paste0("Sourcing the function ", basename(fl))) 
  source(file = fl) 
}
wd <- file.path(getwd(), "data")
```

# Wildlife species modeling

After loading libraries and sourcing needed functions, we load the data and 
format the information we need for the models. The 
`dataCOUNTS.csv` file contains all data for the endangered species. For all species, 
we used the N-mixture model described by Dail and Madsen (2011), which has been 
incorporated into the R package `unmarked`. This model, ran using the function 
`pcountOpen()`, allows for model formulations to identify population trends, 
with and without immigration, and for covariates on initial population (described 
as lambda in the model), population growth (gamma), observation probabilities 
(p) and immigration (iota), when this is considered. This model was chosen as it
could be used for all species, as it also allows for different distributions 
(i.e., Poisson, Negative Binomial and Zero Inflated). 

```{r loadAndCheckData}
Data <- loadData(dataLocation = file.path(wd, "dataCOUNTS.csv"))
```

## Mabuia  

We will start our analysis with the Mabuia (Noronha Skink; *Trachylepis atlantica*).   

First we will run the models for the Ilha do Meio. For the mabuia, Negative 
Binomial Models would have been appropriate, as these model counts, especially if there is variability in the underlying rate of events. However, these are better suited for overdispersed data, which ours 
isn't. Mabuia data is, however, Zero inflated. So ZIP models are more appropriate to use (see Kery, 
2018 and Stoklosa et al. 2022). Moreover, the mabuia population is closed to immigration, considering 
the island is not close enough to others to allow for the species to immigrate. As the predation rate 
by rats is high, we consider every sampling occasion as primary (i.e., open population) and add a 
covariate for the time since the start of the eradication.

```{r mabuiaMeio}
mabuiaMeio <- modelTerrestrials(DT = Data, island = "Ilha do Meio", 
                                species = "Trachylepis atlantica")
```

Now we will run the models for Mabuia for Ilha Rata (our control). 

```{r mabuiaRata}
mabuiaRata <- modelTerrestrials(DT = Data, island = "Ilha Rata", 
                                species = "Trachylepis atlantica")
```

It is important to notice that a couple of the alternative models did not converge 
throwing the error `Hessian is singular.`. This can happen for several reasons 
but in the present case is likely due. Most models that failed had to the parameter 
TSE when to gamma as a covariate, while one model failed with Julian Date. 
Nonetheless, our best model did not have TSE as covariate.

## Elenia  

Next, we will continue our analysis with the Cucuruta (Noronha Elaenia; *Elaenia ridleyana*).  
The observation from Elaenias rendered data that did not present zero inflation. Therefore, 
we used Poisson models, since the overdispersion was also not detected. Differently 
from the Mabuia, the Elaenia does present movement (iota) between the islands, which 
was modeled in the analysis. As we believe the effects of rats on the Elaenia is 
likely restricted to small chicks and eggs, we used the robust design, considering 
a closed population within primary sampling occasions (two days in a row), and open between 
primary sampling occasions (several weeks apart). First we ran the models for the Meio 
island:  

```{r elaeniaMeio}
elaeniaMeio <- modelTerrestrials(DT = Data, island = "Ilha do Meio", 
                                 species = "Elaenia ridleyana")
```

And then for the Rata island:  

```{r elaeniaRata}
elaeniaRata <- modelTerrestrials(DT = Data, island = "Ilha Rata", 
                                 species = "Elaenia ridleyana")
```

## Land Crab  

The analysis of land crabs (*Johngarthia lagostoma*) was then performed. This 
species is known to present increase movement during breeding season. Lesser 
wave action associated with neap high tides (in first and last quarters of moon 
cycle) seem to be preferred. In the same way, peak periods of rain (i.e., March 
or April) also seem to be important factors for these movements. Therefore, we 
added the moon phase to this dataset to use it as a covariate in the model. The 
rainy season should be covered by the covariate JulianDate. Crab data is also 
zero inflated, so we tested both ZIP and NB models. Similarly to Mabuia, although 
the NB model presented a smaller AIC, the dispersion parameter was not significant, 
while the zero inflation was in the ZIP model. Therefore, we opted for a ZIP model.

```{r crabMeio}
crabMeio <- modelTerrestrials(DT = Data, island = "Ilha do Meio", 
                              species = "Johngarthia lagostoma")
```

After modelling crabs for the Ilha do Meio, we perform the same analysis for Ilha Rata:

```{r crabRata}
crabRata <- modelTerrestrials(DT = Data, island = "Ilha Rata", 
                              species = "Johngarthia lagostoma")
```

## Masked Booby

To perform the analysis for a seabird species, the Atoba Mascarado (masked booby; 
*Sula dactylatra*), surveys were performed in all breeding sites across the Ilha 
do Meio (n = 7), and on the only breeding site on Ilha Rata. We used adult counts 
as a proxy for breeding site quality.  

```{r crabMeio}
maskedBoobyMeio <- modelTerrestrials(DT = Data, island = "Ilha do Meio", 
                                     species = "Sula dactylatra")
```

After modelling crabs for the Ilha do Meio, we perform the same analysis for Ilha Rata:

```{r crabRata}
maskedBoobyRata <- modelTerrestrials(DT = Data, island = "Ilha Rata", 
                                     species = "Sula dactylatra")
```

### NEXT STEPS

Now that the models were constructed, we need to calculate the change in population 
density through time for Ilha do Meio, and compare it to the control area (Ilha 
Rata).

```{r changeInPopulationDensity}
changeInPopulation <- calculatePopulationChange(species = c("Trachylepis atlantica",
                                                            "Elaenia ridleyana"#,
                                                            # "Johngarthia lagostoma",
                                                            # "Sula dactylatra"
                                                            ))
```

# Rat population modeling

We also modeled rat population during the eradication efforts. For that, we used spatially 
explicit capture-recapture techniques and the R package `secr` for analysis. Each 
trapping sampling session data (i.e., campaign data of consecutive days) was 
used as a stand-alone, independent dataset. This was done due to the adjustments 
needed on number and disposition of traps for each new monitoring campaign, as 
described in the manuscript. As rats were only captured in the first two campaigns, 
despite increase trapping effort on the third campaign, only these two were modeled.  

Before we model rat abundance, we prepare a mask of the island so the analysis 
occurs only on the island area. This is recommended for island environments due 
to potential edge effects.

```{r mask, echo = TRUE, include = FALSE}
PARNA <- terra::vect(file.path(wd, "Geomorfology.shp")) 
meio <- subset(PARNA, PARNA$AREA_HA == 17.034712, )
aug17 <- secr::read.capthist(captfile =  file.path(wd, "CAPTURE1.txt"),
                               trapfile = file.path(wd, "TRAPS1.txt"))
trapPoints <- traps(aug17)
trapPointsOK <- vect(as.data.frame(trapPoints), geom=c("x", "y"), crs=crs(meio), keepgeom=FALSE)
plot(meio, col = "lightblue")
plot(trapPointsOK, add = TRUE, col = "red")
```

We then check if the traps are located correctly in the shapefile.

```{r testMask, echo = TRUE, eval=FALSE}
clippedmask <- make.mask(trapPoints, type = 'trapbuffer', 
                         buffer = 200, poly = meio)
par(mfrow = c(1,1), mar = c(1,1,1,1))
plot(clippedmask, border = 100, ppoly = FALSE)
gm <- as.data.frame(geom(meio))
polygon(data.frame(x = gm$x, y = gm$y), col = 'lightgreen', border = NA)
plot(clippedmask, dots = FALSE, mesh = grey(0.4), col = NA, polycol = 'blue', add = TRUE)
plot(trapPoints, detpar = list(pch = 16, cex = 0.8), add = TRUE)
```

Everything seems to be fine. Now we can perform our analysis.

## Meio, August 2017 - First monitoring campaign

```{r aug17, echo = TRUE, include = FALSE}

aug17 <- secr::read.capthist(captfile =  file.path(wd, "CAPTURE1.txt"),
                               trapfile = file.path(wd, "TRAPS1.txt")) # We have already read the file before so we could extract the trap's information. Here it is again for consistency.
summary(aug17)

g0.1 <- secr.fit(aug17, model = list(g0 ~ 1, sigma ~ 1), CL = TRUE,
                 verify = TRUE, mask = clippedmask)

densityAUG17 <- derived(g0.1)
densityAUG17
```

We tested different model formulations (i.e., landscape covariates and also 
different buffers; see previous commits to see code).  
Model diagnostics (i.e., AIC) supported the use of the simplest model (i.e., 
detection probability doesn't change), and the island shapefile as a mask. 
Applying the mask or buffer of 200 didn't change the results, but other buffers 
did.

Home range results (sigma estimate, lcl = lowe95%CI; ucl = upper95%CI):
```{r, echo = FALSE}
knitr::kable(summary(g0.1)$predicted)
```

Density results (D estimate, lcl = lowe95%CI; ucl = upper95%CI):
```{r, echo = FALSE}
knitr::kable(densityAUG17)
```

## Meio, October 2017 - Second monitoring campaign

```{r oct17, echo = TRUE, include = FALSE}
oct17 <- secr::read.capthist(captfile =  file.path(wd, "CAPTURE2.txt"),
                               trapfile = file.path(wd, "TRAPS2.txt"))
summary(oct17)
g0.2 <- secr.fit(oct17, model = list(g0 ~ 1, sigma ~ 1), CL = TRUE,
                 verify = TRUE, mask = clippedmask)

densityOCT17 <- derived(g0.2)
densityOCT17
```

Double checking where the traps are located  

```{r testMask2, echo = TRUE, eval=FALSE}
trapPoints <- traps(oct17)
par(mfrow = c(1,1), mar = c(1,1,1,1))
plot(clippedmask, border = 100, ppoly = FALSE)
gm <- as.data.frame(geom(meio))
polygon(data.frame(x = gm$x, y = gm$y), col = 'lightgreen', border = NA)
plot(clippedmask, dots = FALSE, mesh = grey(0.4), col = NA, polycol = 'blue', add = TRUE)
plot(trapPoints, detpar = list(pch = 16, cex = 0.8), add = TRUE)
```

Home range results (sigma estimate, lcl exce= lowe95%CI; ucl = upper95%CI):
```{r, echo = FALSE}
knitr::kable(summary(g0.2)$predicted)
```

Density results (D estimate, lcl = lowe95%CI; ucl = upper95%CI):
```{r, echo = FALSE}
knitr::kable(densityOCT17)
```

# Building final plot

First, we need to put both results for the rats together to pass to the final plotting 
function:

```{r plotPopGrowth}
plotGrowth <- plotPopulationGrowth(dataset = changeInPopulation)
```

At last, we build a plot to show the difference in growth rate through time in function 
of time since eradication (TSE) using the control to control for seasonality. We use growth 
rate instead of other parameters (i.e., population density) due to the compounded uncertainty 
in the last due to both uncertainty in initial population and population growth rate.  
Moreover, growth rate shows exactly what we sought with the current work, the population trend 
through time.

```{r plotPopGrowth}
plotGrowth <- plotPopulationGrowth(dataset = changeInPopulation)
```

***ADD TO PAPER (TABLE) THAT POPULATION DENSITY IS BASED ON AVERAGE INITIAL POPULATION AND DO NOT 
ACCOUNT FOR THE ORIGINAL UNCERTAINTY IN THIS PARAMETER, BUT ONLY ON THE UNCERTAINTY IN POP GROWTH RATE.
MAYBE EXCLUDE THIS ALL TOGETHER. FEELING THIS MIGHT BE TRICKY.***
